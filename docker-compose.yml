services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.3
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  kafka:
    image: confluentinc/cp-kafka:7.5.3
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"

  kafka-init:
    image: confluentinc/cp-kafka:7.5.3
    depends_on:
      - kafka
    entrypoint: /bin/bash -c "sleep 8 && kafka-topics --create --if-not-exists --topic route.events --bootstrap-server kafka:9092 --replication-factor 1 --partitions 3 && kafka-topics --create --if-not-exists --topic bus.location.events --bootstrap-server kafka:9092 --replication-factor 1 --partitions 5 && kafka-topics --create --if-not-exists --topic bus.status.events --bootstrap-server kafka:9092 --replication-factor 1 --partitions 3 && kafka-topics --create --if-not-exists --topic traffic.reading.events --bootstrap-server kafka:9092 --replication-factor 1 --partitions 5 && kafka-topics --create --if-not-exists --topic sensor.status.events --bootstrap-server kafka:9092 --replication-factor 1 --partitions 3 && kafka-topics --create --if-not-exists --topic incident.events --bootstrap-server kafka:9092 --replication-factor 1 --partitions 3 && kafka-topics --create --if-not-exists --topic car.location.events --bootstrap-server kafka:9092 --replication-factor 1 --partitions 5 && kafka-topics --create --if-not-exists --topic car.status.events --bootstrap-server kafka:9092 --replication-factor 1 --partitions 3 || true"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redisdata:/data

  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: kledionberisha
      POSTGRES_PASSWORD: kledion123
      POSTGRES_DB: cityflow
    ports:
      - "5433:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  mongo:
    image: mongo:7
    ports:
      - "27017:27017"
    volumes:
      - mongodata:/data/db

  keycloak:
    image: quay.io/keycloak/keycloak:22.0.5
    command: start-dev --http-port 8080 --import-realm
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    volumes:
      - ./infrastructure/keycloak/realm-cityflow.json:/opt/keycloak/data/import/realm-cityflow.json:ro

  route-mgmt-service:
    build:
      context: ./backend/route-mgmt-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/cityflow
      SPRING_DATASOURCE_USERNAME: kledionberisha
      SPRING_DATASOURCE_PASSWORD: kledion123
      SERVER_PORT: 8081
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:8080/realms/cityflow
      KEYCLOAK_AUTH_SERVER_URL: http://keycloak:8080
      KEYCLOAK_ENABLED: "true"
      APP_SECURITY_ENABLED: "false"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      APP_KAFKA_ENABLED: "true"
    ports:
      - "8081:8081"
    depends_on:
      - postgres
      - kafka
      - kafka-init
      - keycloak

  bus-ingestion-service:
    build:
      context: ./backend/bus-ingestion-service
    environment:
      SERVER_PORT: 8082
      SPRING_DATA_MONGODB_URI: mongodb://mongo:27017/cityflow
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      OAUTH2_ISSUER_URI: http://keycloak:8080/realms/cityflow
      APP_SECURITY_ENABLED: "false"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      APP_KAFKA_ENABLED: "true"
      APP_SIMULATOR_ENABLED: "true"
      APP_SIMULATOR_MODE: "prishtina"
      ROUTE_SERVICE_URL: http://route-mgmt-service:8081
    ports:
      - "8082:8082"
    depends_on:
      - mongo
      - redis
      - kafka
      - kafka-init
      - keycloak

  traffic-ingestion-service:
    build:
      context: ./backend/traffic-ingestion-service
    environment:
      SERVER_PORT: 8083
      SPRING_DATA_MONGODB_URI: mongodb://mongo:27017/cityflow
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      OAUTH2_ISSUER_URI: http://keycloak:8080/realms/cityflow
      APP_SECURITY_ENABLED: "false"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      APP_KAFKA_ENABLED: "true"
      APP_SIMULATOR_ENABLED: "true"
    ports:
      - "8083:8083"
    depends_on:
      - mongo
      - redis
      - kafka
      - kafka-init
      - keycloak

  car-ingestion-service:
    build:
      context: ./backend/car-ingestion-service
    environment:
      SERVER_PORT: 8088
      SPRING_DATA_MONGODB_URI: mongodb://mongo:27017/cityflow
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      OAUTH2_ISSUER_URI: http://keycloak:8080/realms/cityflow
      APP_SECURITY_ENABLED: "false"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      APP_KAFKA_ENABLED: "true"
      APP_SIMULATOR_ENABLED: "true"
      APP_SIMULATOR_INITIAL_CAR_COUNT: 50
      APP_SIMULATOR_CITY_BOUNDS_MIN_LAT: 42.62
      APP_SIMULATOR_CITY_BOUNDS_MAX_LAT: 42.70
      APP_SIMULATOR_CITY_BOUNDS_MIN_LON: 21.10
      APP_SIMULATOR_CITY_BOUNDS_MAX_LON: 21.20
    ports:
      - "8088:8088"
    depends_on:
      - mongo
      - redis
      - kafka
      - kafka-init
      - keycloak

  analytics-service:
    build:
      context: ./backend/analytics-service
    environment:
      SERVER_PORT: 8084
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      OAUTH2_ISSUER_URI: http://keycloak:8080/realms/cityflow
      APP_SECURITY_ENABLED: "false"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      APP_KAFKA_ENABLED: "true"
    ports:
      - "8084:8084"
    depends_on:
      - redis
      - kafka
      - kafka-init
      - keycloak

  notification-service:
    build:
      context: ./backend/notification-service
    environment:
      SERVER_PORT: 8085
      SPRING_DATA_MONGODB_URI: mongodb://mongo:27017/cityflow
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      OAUTH2_ISSUER_URI: http://keycloak:8080/realms/cityflow
      APP_SECURITY_ENABLED: "false"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      APP_KAFKA_ENABLED: "true"
    ports:
      - "8085:8085"
    depends_on:
      - mongo
      - redis
      - kafka
      - kafka-init
      - keycloak

  incident-detection-service:
    build:
      context: ./backend/incident-detection-service
    environment:
      SERVER_PORT: 8086
      SPRING_DATA_MONGODB_URI: mongodb://mongo:27017/cityflow
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      OAUTH2_ISSUER_URI: http://keycloak:8080/realms/cityflow
      APP_SECURITY_ENABLED: "false"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      APP_KAFKA_ENABLED: "true"
    ports:
      - "8086:8086"
    depends_on:
      - mongo
      - redis
      - kafka
      - kafka-init
      - keycloak
      - traffic-ingestion-service
      - bus-ingestion-service

  api-gateway:
    build:
      context: ./backend/api-gateway
    environment:
      SERVER_PORT: 8000
      ROUTE_SERVICE_URL: http://route-mgmt-service:8081
      BUS_SERVICE_URL: http://bus-ingestion-service:8082
      TRAFFIC_SERVICE_URL: http://traffic-ingestion-service:8083
      ANALYTICS_SERVICE_URL: http://analytics-service:8084
      NOTIFICATION_SERVICE_URL: http://notification-service:8085
      INCIDENT_SERVICE_URL: http://incident-detection-service:8086
      CAR_SERVICE_URL: http://car-ingestion-service:8088
      ML_SERVICE_URL: http://ml-api:8090
      OAUTH2_ISSUER_URI: http://keycloak:8080/realms/cityflow
      APP_SECURITY_ENABLED: "false"
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
    ports:
      - "8000:8000"
    depends_on:
      - route-mgmt-service
      - bus-ingestion-service
      - traffic-ingestion-service
      - car-ingestion-service
      - analytics-service
      - notification-service
      - incident-detection-service
      - ml-api
      - redis
      - keycloak

  # MLflow Tracking Server
  mlflow:
    image: python:3.10-slim
    container_name: cityflow-mlflow
    command: >
      sh -c "apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/* &&
             pip install mlflow==2.9.2 psycopg2-binary &&
             mlflow server --backend-store-uri sqlite:///mlflow.db --default-artifact-root ./mlruns --host 0.0.0.0 --port 5001"
    ports:
      - "5001:5001"
    volumes:
      - mlflow_data:/app
    working_dir: /app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ML Model Serving API
  ml-api:
    build:
      context: ./data-processing/machine-learning
      dockerfile: Dockerfile
    container_name: cityflow-ml-api
    command: python model_serving_api.py
    ports:
      - "8090:8090"
      - "9095:9090"
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5001
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=cityflow
      - POSTGRES_USER=kledionberisha
      - POSTGRES_PASSWORD=kledion123
      - MONGODB_URI=mongodb://mongo:27017/cityflow
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    volumes:
      - ./data-processing/machine-learning/models:/app/models
      - ./data-processing/machine-learning/logs:/app/logs
      - ./data-processing/machine-learning/config.yaml:/app/config.yaml
      - ./data-processing/machine-learning/model_serving_api.py:/app/model_serving_api.py
    depends_on:
      - mlflow
      - postgres
      - mongo
      - redis
      - kafka
    restart: unless-stopped

volumes:
  pgdata:
  mongodata:
  redisdata:
  mlflow_data: